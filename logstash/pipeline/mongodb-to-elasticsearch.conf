input {
  mongodb {
    uri => "mongodb://mongodb:27017/social_sentiment"
    placeholder_db_dir => "/tmp/logstash-mongodb"
    placeholder_db_name => "logstash_sqlite.db"
    collection => "posts"
    batch_size => 1000
    parse_method => "simple"
    generateId => true
  }
}

filter {
  # Conversion de la date
  date {
    match => [ "created_at", "ISO8601" ]
    target => "@timestamp"
  }
  
  # Extraction des champs imbriquÃ©s
  if [user] {
    mutate {
      add_field => {
        "user_name" => "%{[user][name]}"
        "user_location" => "%{[user][location]}"
      }
    }
  }
  
  if [sentiment_analysis] {
    mutate {
      add_field => {
        "sentiment_label" => "%{[sentiment_analysis][sentiment]}"
      }
      copy => {
        "[sentiment_analysis][score]" => "sentiment_score"
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "ai-sentiment-%{+YYYY.MM.dd}"
  }
}